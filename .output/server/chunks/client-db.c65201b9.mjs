import t from"unstorage/drivers/memory";import{prefixStorage as e,createStorage as r}from"unstorage";import{e as i,z as n,f as o,c as a,o as s,p as c,r as p,t as m,v as l,x as u,y as d}from"./server.mjs";import{withBase as f}from"ufo";import{pascalCase as g}from"scule";import"vue";import"ohmyfetch";import"hookable";import"unctx";import"destr";import"h3";import"defu";import"vue-router";import"vue/server-renderer";import"@iconify/vue/dist/offline";import"@iconify/vue";import"ohash";import"cookie-es";import"lodash-es";import"@formkit/auto-animate";import"./node-server.mjs";import"node-fetch-native/polyfill";import"http";import"https";import"unenv/runtime/fetch/index";import"unstorage/drivers/overlay";import"radix3";import"fs";import"pathe";import"url";import"unified";import"mdast-util-to-string";import"micromark/lib/preprocess.js";import"micromark/lib/postprocess.js";import"unist-util-stringify-position";import"micromark-util-character";import"micromark-util-chunked";import"micromark-util-resolve-all";import"remark-emoji";import"rehype-slug";import"remark-squeeze-paragraphs";import"rehype-external-links";import"remark-gfm";import"rehype-sort-attribute-values";import"rehype-sort-attributes";import"rehype-raw";import"remark-mdc";import"remark-parse";import"remark-rehype";import"mdast-util-to-hast";import"detab";import"unist-builder";import"mdurl";import"slugify";import"unist-util-position";import"html-tags";function createMatch(t={}){const e=function(t,e={}){return{$match:(e,r)=>t(e,r),$eq:(t,e)=>e instanceof RegExp?e.test(t):t===e,$ne:(t,e)=>e instanceof RegExp?!e.test(t):t!==e,$not:(e,r)=>!t(e,r),$and:(e,r)=>(c(r,"$and requires an array as condition"),r.every((r=>t(e,r)))),$or:(e,r)=>(c(r,"$or requires an array as condition"),r.some((r=>t(e,r)))),$in:(e,r)=>p(r).some((r=>Array.isArray(e)?t(e,{$contains:r}):t(e,r))),$contains:(t,e)=>(t=Array.isArray(t)?t:String(t),p(e).every((e=>t.includes(e)))),$icontains:(t,e)=>{if("string"!=typeof e)throw new TypeError("$icontains requires a string, use $contains instead");return t=String(t).toLocaleLowerCase(),p(e).every((e=>t.includes(e.toLocaleLowerCase())))},$containsAny:(t,e)=>(c(e,"$containsAny requires an array as condition"),t=Array.isArray(t)?t:String(t),e.some((e=>t.includes(e)))),$exists:(t,e)=>e?void 0!==t:void 0===t,$type:(t,e)=>typeof t===String(e),$regex:(t,e)=>{if(!(e instanceof RegExp)){const t=String(e).match(/\/(.*)\/([dgimsuy]*)$/);e=t?new RegExp(t[1],t[2]||""):new RegExp(e)}return e.test(String(t||""))},$lt:(t,e)=>t<e,$lte:(t,e)=>t<=e,$gt:(t,e)=>t>e,$gte:(t,e)=>t>=e,...e||{}}}(match,t.operators);function match(t,r){return"object"!=typeof r||r instanceof RegExp?e.$eq(t,r):Object.keys(r||{}).every((i=>{const n=r[i];if(i.startsWith("$")&&e[i]){const r=e[i];return"function"==typeof r&&r(t,n)}return match(s(t,i),n)}))}return match}function createPipelineFetcher(t){const e=createMatch(),r=[(t,r)=>t.filter((t=>p(r.where).every((r=>e(t,r))))),(t,e)=>p(e.sort).forEach((e=>m(t,e))),(t,r)=>r.surround?((t,{query:r,before:i,after:n})=>{const o="string"==typeof r?{_path:r}:r,a=t.findIndex((t=>e(t,o)));i=i||1,n=n||1;const s=new Array(i+n).fill(null,0);return-1===a?s:s.map(((e,r)=>t[a-i+r+Number(r>=i)]||null))})(t,r.surround):t,(t,e)=>e.skip?t.slice(e.skip):t,(t,e)=>e.limit?t.slice(0,e.limit):t,(t,e)=>l(u(e.without))(t),(t,e)=>l(d(e.only))(t),(t,e)=>e.first?t[0]:t];return async e=>{const i=await t();return r.reduce(((t,r)=>r(t,e.params())||t),i)}}function createNav(t,e){const{navigation:r}=a().content,pickNavigationFields=t=>{return{...(i=["title",...r.fields],t=>(t=t||{},i&&i.length?i.filter((e=>void 0!==t[e])).reduce(((e,r)=>Object.assign(e,{[r]:t[r]})),{}):t))(t),...(e=null==t?void 0:t.navigation,"[object Object]"===Object.prototype.toString.call(e)?t.navigation:{})};var e,i};return sortAndClear(t.sort(((t,e)=>t._path.localeCompare(e._path))).reduce(((t,r)=>{const i=r._path.substring(1).split("/"),n=r._id.split(":").slice(1),o=!!n[n.length-1].match(/([1-9][0-9]*\.)?index.md/g),getNavItem=t=>({title:t.title,_path:t._path,_file:t._file,children:[],...pickNavigationFields(t),...t._draft?{_draft:!0}:{}}),a=getNavItem(r);if(o){const i=e[a._path];if(void 0!==(null==i?void 0:i.navigation)&&!(null==i?void 0:i.navigation))return t;if("/"!==r._path){const t=getNavItem(r);a.children.push(t)}Object.assign(a,pickNavigationFields(i))}if(1===i.length)return t.push(a),t;return i.slice(0,-1).reduce(((t,n,o)=>{const a="/"+i.slice(0,o+1).join("/"),s=e[a];if(void 0!==(null==s?void 0:s.navigation)&&!s.navigation)return[];let c=t.find((t=>t._path===a));var p;return c||(c={title:(p=n,p.split(/[\s-]/g).map(g).join(" ")),_path:a,_file:r._file,children:[],...pickNavigationFields(s)},t.push(c)),c.children}),t).push(a),t}),[]))}const h=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function sortAndClear(t){const e=t.sort(((t,e)=>h.compare(t._file,e._file)));for(const t of e)t.children.length?sortAndClear(t.children):delete t.children,delete t._file;return t}const y=e(r({driver:t()}),"@content"),getPreview=()=>i("previewToken").value;function createDB(t){async function getItems(){const e=new Set(await t.getKeys("cache:")),r=getPreview();if(r){(await t.getItem(`${r}$`).then((t=>t||{}))).ignoreBuiltContents&&e.clear();const i=await t.getKeys(`${r}:`),n=await Promise.all(i.map((e=>t.getItem(e))));for(const t of n)e.delete(`cache:${t._id}`),t.__deleted||e.add(`${r}:${t._id}`)}return await Promise.all(Array.from(e).map((e=>t.getItem(e))))}return{storage:t,fetch:createPipelineFetcher(getItems),query:t=>n(createPipelineFetcher(getItems),t)}}let v,$;async function useContentDatabase(){return $?await $:v||($=async function(){const t=o(),{clientDB:e}=a().public.content,r=createDB(y),i=await r.storage.getItem("integrity");if(e.integrity!==+i){const{contents:t,navigation:i}=await $fetch((n="cache.json",f(n,"/api/"+a().public.content.base)));await Promise.all(t.map((t=>r.storage.setItem(`cache:${t._id}`,t)))),await r.storage.setItem("navigation",i),await r.storage.setItem("integrity",e.integrity)}var n;return await t.callHook("content:storage",r.storage),r}(),v=await $),v}async function generateNavigation(t){const e=await useContentDatabase();if(!getPreview()&&0===Object.keys(t||{}).length)return e.storage.getItem("navigation");return createNav(await e.query(t).where({_partial:!1,navigation:{$ne:!1}}).find(),(await e.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce(((t,e)=>{"dir"===e.title.toLowerCase()&&(e.title=void 0);return t[e._path.split("/").slice(0,-1).join("/")||"/"]={...e,...e.body},t}),{}))}export{y as contentStorage,createDB,generateNavigation,getPreview,useContentDatabase};
//# sourceMappingURL=client-db.c65201b9.mjs.map
