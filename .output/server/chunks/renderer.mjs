import{renderResourceHeaders as e,createRenderer as t}from"vue-bundle-renderer/runtime";import{eventHandler as r,getQuery as n,writeEarlyHints as s}from"h3";import{renderToString as i}from"vue/server-renderer";import{joinURL as o}from"ufo";import{u as a,a as u,g as l}from"./node-server.mjs";import"node-fetch-native/polyfill";import"http";import"https";import"destr";import"ohmyfetch";import"unenv/runtime/fetch/index";import"hookable";import"scule";import"ohash";import"unstorage";import"unstorage/drivers/overlay";import"unstorage/drivers/memory";import"defu";import"radix3";import"fs";import"pathe";import"url";import"unified";import"mdast-util-to-string";import"micromark/lib/preprocess.js";import"micromark/lib/postprocess.js";import"unist-util-stringify-position";import"micromark-util-character";import"micromark-util-chunked";import"micromark-util-resolve-all";import"remark-emoji";import"rehype-slug";import"remark-squeeze-paragraphs";import"rehype-external-links";import"remark-gfm";import"rehype-sort-attribute-values";import"rehype-sort-attributes";import"rehype-raw";import"remark-mdc";import"remark-parse";import"remark-rehype";import"mdast-util-to-hast";import"detab";import"unist-builder";import"mdurl";import"slugify";import"unist-util-position";import"html-tags";const c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_$",p=/[<>\b\f\n\r\t\0\u2028\u2029]/g,d=/^(?:do|if|in|for|int|let|new|try|var|byte|case|char|else|enum|goto|long|this|void|with|await|break|catch|class|const|final|float|short|super|throw|while|yield|delete|double|export|import|native|return|switch|throws|typeof|boolean|default|extends|finally|package|private|abstract|continue|debugger|function|volatile|interface|protected|transient|implements|instanceof|synchronized)$/,f={"<":"\\u003C",">":"\\u003E","/":"\\u002F","\\":"\\\\","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","\0":"\\0","\u2028":"\\u2028","\u2029":"\\u2029"},m=Object.getOwnPropertyNames(Object.prototype).sort().join("\0");function devalue(e){const t=new Map;let r=0;function log(e){r<100&&(console.warn(e),r+=1)}!function walk(e){if("function"!=typeof e){if(t.has(e))t.set(e,t.get(e)+1);else if(t.set(e,1),!isPrimitive(e)){switch(getType(e)){case"Number":case"String":case"Boolean":case"Date":case"RegExp":return;case"Array":e.forEach(walk);break;case"Set":case"Map":Array.from(e).forEach(walk);break;default:const t=Object.getPrototypeOf(e);t!==Object.prototype&&null!==t&&Object.getOwnPropertyNames(t).sort().join("\0")!==m?"function"!=typeof e.toJSON&&log(`Cannot stringify arbitrary non-POJOs ${e.constructor.name}`):Object.getOwnPropertySymbols(e).length>0?log(`Cannot stringify POJOs with symbolic keys ${Object.getOwnPropertySymbols(e).map((e=>e.toString()))}`):Object.keys(e).forEach((t=>walk(e[t])))}}}else log(`Cannot stringify a function ${e.name}`)}(e);const n=new Map;function stringify(e){if(n.has(e))return n.get(e);if(isPrimitive(e))return stringifyPrimitive(e);const t=getType(e);switch(t){case"Number":case"String":case"Boolean":return`Object(${stringify(e.valueOf())})`;case"RegExp":return e.toString();case"Date":return`new Date(${e.getTime()})`;case"Array":const r=e.map(((t,r)=>r in e?stringify(t):"")),n=0===e.length||e.length-1 in e?"":",";return`[${r.join(",")}${n}]`;case"Set":case"Map":return`new ${t}([${Array.from(e).map(stringify).join(",")}])`;default:if(e.toJSON){let t=e.toJSON();if("String"===getType(t))try{t=JSON.parse(t)}catch(e){}return stringify(t)}return null===Object.getPrototypeOf(e)?0===Object.keys(e).length?"Object.create(null)":`Object.create(null,{${Object.keys(e).map((t=>`${safeKey(t)}:{writable:true,enumerable:true,value:${stringify(e[t])}}`)).join(",")}})`:`{${Object.keys(e).map((t=>`${safeKey(t)}:${stringify(e[t])}`)).join(",")}}`}}Array.from(t).filter((e=>e[1]>1)).sort(((e,t)=>t[1]-e[1])).forEach(((e,t)=>{n.set(e[0],function(e){let t="";do{t=c[e%c.length]+t,e=~~(e/c.length)-1}while(e>=0);return d.test(t)?`${t}0`:t}(t))}));const s=stringify(e);if(n.size){const e=[],t=[],r=[];return n.forEach(((n,s)=>{if(e.push(n),isPrimitive(s))return void r.push(stringifyPrimitive(s));switch(getType(s)){case"Number":case"String":case"Boolean":r.push(`Object(${stringify(s.valueOf())})`);break;case"RegExp":r.push(s.toString());break;case"Date":r.push(`new Date(${s.getTime()})`);break;case"Array":r.push(`Array(${s.length})`),s.forEach(((e,r)=>{t.push(`${n}[${r}]=${stringify(e)}`)}));break;case"Set":r.push("new Set"),t.push(`${n}.${Array.from(s).map((e=>`add(${stringify(e)})`)).join(".")}`);break;case"Map":r.push("new Map"),t.push(`${n}.${Array.from(s).map((([e,t])=>`set(${stringify(e)}, ${stringify(t)})`)).join(".")}`);break;default:r.push(null===Object.getPrototypeOf(s)?"Object.create(null)":"{}"),Object.keys(s).forEach((e=>{t.push(`${n}${function(e){return/^[_$a-zA-Z][_$a-zA-Z0-9]*$/.test(e)?`.${e}`:`[${escapeUnsafeChars(JSON.stringify(e))}]`}(e)}=${stringify(s[e])}`)}))}})),t.push(`return ${s}`),`(function(${e.join(",")}){${t.join(";")}}(${r.join(",")}))`}return s}function isPrimitive(e){return Object(e)!==e}function stringifyPrimitive(e){if("string"==typeof e)return function(e){let t='"';for(let r=0;r<e.length;r+=1){const n=e.charAt(r),s=n.charCodeAt(0);if('"'===n)t+='\\"';else if(n in f)t+=f[n];else if(s>=55296&&s<=57343){const i=e.charCodeAt(r+1);t+=s<=56319&&i>=56320&&i<=57343?n+e[++r]:`\\u${s.toString(16).toUpperCase()}`}else t+=n}return t+='"',t}(e);if(void 0===e)return"void 0";if(0===e&&1/e<0)return"-0";const t=String(e);return"number"==typeof e?t.replace(/^(-)?0\./,"$1."):t}function getType(e){return Object.prototype.toString.call(e).slice(8,-1)}function escapeUnsafeChar(e){return f[e]||e}function escapeUnsafeChars(e){return e.replace(p,escapeUnsafeChar)}function safeKey(e){return/^[_$a-zA-Z][_$a-zA-Z0-9]*$/.test(e)?e:escapeUnsafeChars(JSON.stringify(e))}function buildAssetsURL(...e){return o(publicAssetsURL(),u().app.buildAssetsDir,...e)}function publicAssetsURL(...e){const t=u().app.cdnURL||u().app.baseURL;return e.length?o(t,...e):t}globalThis.__buildAssetsURL=buildAssetsURL,globalThis.__publicAssetsURL=publicAssetsURL;const getClientManifest=()=>import("./client.manifest.mjs").then((e=>e.default||e)).then((e=>"function"==typeof e?e():e)),y=lazyCachedFunction((async()=>{const e=await getClientManifest();if(!e)throw new Error("client.manifest is not available");const r=await import("./server.mjs").then((e=>e.default||e));if(!r)throw new Error("Server bundle is not available");return t(r,{manifest:e,renderToString:async function(e,t){return`<div id="__nuxt">${await i(e,t)}</div>`},buildAssetsURL:buildAssetsURL})})),h=lazyCachedFunction((async()=>{const e=await getClientManifest(),r=t((()=>()=>{}),{manifest:e,renderToString:()=>'<div id="__nuxt"></div>',buildAssetsURL:buildAssetsURL}),n=await r.renderToString({});return{rendererContext:r.rendererContext,renderToString:e=>{const t=u();return e.payload={serverRendered:!1,config:{public:t.public,app:t.app},data:{},state:{}},e.renderMeta=e.renderMeta??(()=>({})),Promise.resolve(n)}}})),g=/\/_payload(\.[a-zA-Z0-9]+)?.js(\?.*)?$/,b=(A=async t=>{const r=t.req.url?.startsWith("/__nuxt_error")?n(t):null;let i=r?.url||t.req.url;const o=g.test(i);o&&(i=i.substring(0,i.lastIndexOf("/"))||"/",t.req.url=i);const c=l(t),p={url:i,event:t,runtimeConfig:u(),noSSR:!!t.req.headers["x-nuxt-no-ssr"]||!1===c.ssr||!1,error:!!r,nuxt:void 0,payload:r?{error:r}:{}},d=p.noSSR?await h():await y();if(!o){const{link:r}=e({},d.rendererContext);s(t,r)}const f=await d.renderToString(p).catch((e=>{if(!r)throw p.payload?.error||e}));if(await(p.nuxt?.hooks.callHook("app:rendered",{ssrContext:p})),!f)return;if(p.payload?.error&&!r)throw p.payload.error;if(o){const e=function(e){return{body:`export default ${devalue(splitPayload(e).payload)}`,statusCode:e.event.res.statusCode,statusMessage:e.event.res.statusMessage,headers:{"content-type":"text/javascript;charset=UTF-8","x-powered-by":"Nuxt"}}}(p);return e}const m=await(p.renderMeta?.())??{},b=await async function(e){const{entryCSS:t}=await getClientManifest(),r=await import("./styles.mjs").then((function(e){return e.w})).then((e=>e.default||e)),n=new Set;for(const t of["entry",...e])if(t in r)for(const e of await r[t]())n.add(`<style>${e}</style>`);for(const e of t?.css||[])n.add(`<link rel="stylesheet" href=${JSON.stringify(buildAssetsURL(e))} media="print" onload="this.media='all'; this.onload=null;">`);return Array.from(n).join("")}(p.modules??p._registeredComponents??[]),A={htmlAttrs:normalizeChunks([m.htmlAttrs]),head:normalizeChunks([m.headTags,null,f.renderResourceHints(),f.renderStyles(),b,p.styles]),bodyAttrs:normalizeChunks([m.bodyAttrs]),bodyPreprend:normalizeChunks([m.bodyScriptsPrepend,p.teleports?.body]),body:[f.html],bodyAppend:normalizeChunks([`<script>window.__NUXT__=${devalue(p.payload)}<\/script>`,f.renderScripts(),m.bodyScripts])},w=a();var $;return await w.hooks.callHook("render:html",A,{event:t}),{body:($=A,`<!DOCTYPE html>\n<html ${joinAttrs($.htmlAttrs)}>\n<head>${joinTags($.head)}</head>\n<body ${joinAttrs($.bodyAttrs)}>${joinTags($.bodyPreprend)}${joinTags($.body)}${joinTags($.bodyAppend)}</body>\n</html>`),statusCode:t.res.statusCode,statusMessage:t.res.statusMessage,headers:{"Content-Type":"text/html;charset=UTF-8","X-Powered-By":"Nuxt"}}},r((async e=>{if(e.req.url.endsWith("/favicon.ico"))return e.res.setHeader("Content-Type","image/x-icon"),void e.res.end("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7");const t=await A(e);if(!t)return void(e.res.writableEnded||(e.res.statusCode=200===e.res.statusCode?500:e.res.statusCode,e.res.end("No response returned from render handler: "+e.req.url)));const r=a();if(await r.hooks.callHook("render:response",t,{event:e}),!e.res.headersSent&&t.headers){for(const r in t.headers)e.res.setHeader(r,t.headers[r]);t.statusCode&&(e.res.statusCode=t.statusCode),t.statusMessage&&(e.res.statusMessage=t.statusMessage)}return"string"==typeof t.body?t.body:JSON.stringify(t.body)})));var A;function lazyCachedFunction(e){let t=null;return()=>(null===t&&(t=e().catch((e=>{throw t=null,e}))),t)}function normalizeChunks(e){return e.filter(Boolean).map((e=>e.trim()))}function joinTags(e){return e.join("")}function joinAttrs(e){return e.join(" ")}function splitPayload(e){const{data:t,prerenderedAt:r,...n}=e.payload;return{initial:{...n,prerenderedAt:r},payload:{data:t,prerenderedAt:r}}}export{b as default};
//# sourceMappingURL=renderer.mjs.map
